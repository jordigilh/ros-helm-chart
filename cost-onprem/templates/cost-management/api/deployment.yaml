apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "cost-onprem.koku.api.name" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-onprem.koku.labels" . | nindent 4 }}
    app.kubernetes.io/component: cost-management-api
spec:
  replicas: {{ .Values.costManagement.api.replicas }}
  selector:
    matchLabels:
      {{- include "cost-onprem.koku.api.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "cost-onprem.koku.labels" . | nindent 8 }}
        app.kubernetes.io/component: cost-management-api
    spec:
      serviceAccountName: {{ include "cost-onprem.koku.serviceAccountName" . }}
      automountServiceAccountToken: false

      securityContext:
        {{- include "cost-onprem.securityContext.pod.nonRoot" . | nindent 8 }}

      initContainers:
      {{- include "cost-onprem.koku.initContainer.combineCA" . | nindent 6 }}
      # NOTE: Migrations are now handled by a pre-upgrade/pre-install Helm Job
      # See: templates/cost-management/jobs/migration.yaml

      containers:
      - name: koku-api
        image: "{{ include "cost-onprem.koku.image" . }}"
        imagePullPolicy: {{ .Values.costManagement.api.image.pullPolicy }}
        securityContext:
          {{- include "cost-onprem.securityContext.container" . | nindent 10 }}

        # Use image's default entrypoint (./scripts/entrypoint.sh)
        # which handles migrations and starts gunicorn correctly

        ports:
        - name: http
          containerPort: {{ include "cost-onprem.koku.api.port" . }}
          protocol: TCP

        env:
        {{- include "cost-onprem.koku.commonEnv" . | nindent 8 }}
        # POD_CPU_LIMIT is required for gunicorn worker calculation
        # Without it, gunicorn spawns workers based on host CPU count, causing OOM
        - name: POD_CPU_LIMIT
          valueFrom:
            resourceFieldRef:
              containerName: koku-api
              resource: limits.cpu
        {{- range $key, $value := .Values.costManagement.api.env }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}

        livenessProbe:
          {{- toYaml .Values.costManagement.api.livenessProbe | nindent 10 }}

        readinessProbe:
          {{- toYaml .Values.costManagement.api.readinessProbe | nindent 10 }}

        resources:
          {{- toYaml .Values.costManagement.api.resources | nindent 10 }}

        volumeMounts:
        {{- include "cost-onprem.koku.volumeMounts" . | nindent 8 }}

        securityContext:
          {{- include "cost-onprem.securityContext.container" . | nindent 10 }}

      volumes:
      {{- include "cost-onprem.koku.volumes" . | nindent 6 }}
