{{- if eq (include "cost-onprem.jwt.shouldEnable" .) "true" }}
apiVersion: authorino.kuadrant.io/v1beta3
kind: AuthConfig
metadata:
  name: {{ include "cost-onprem.fullname" . }}-ros-api-auth
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-onprem.labels" . | nindent 4 }}
    app.kubernetes.io/component: authorino-authconfig
spec:
  # Define the hosts that this AuthConfig applies to
  # Use wildcard to match all hosts (Envoy is already doing host validation via routes)
  hosts:
    - "*"

  # Authentication: Validate Kubernetes tokens via TokenReview
  # Accepts tokens with the default Kubernetes API audience
  # This includes:
  #   - Interactive user tokens from OpenShift Console (primary use case)
  #   - Service account tokens without explicit audience
  # The Kubernetes TokenReview API validates the token authenticity
  # Note: credentials defaults to Authorization header with "Bearer" prefix if omitted
  # Note: Fine-grained authorization (e.g., blocking service accounts) should be
  #       implemented at the application level based on the authenticated username
  authentication:
    "kubernetes-tokens":
      kubernetesTokenReview:
        audiences:
          - "https://kubernetes.default.svc"  # Default Kubernetes API audience

  # Metadata: Extract org_id and account_number from user groups
  # Uses OPA/Rego to parse LDAP-mapped groups from Keycloak
  # Groups structure:
  #   - Groups with "organization_id_" prefix (e.g., "organization_id_1234567")
  #   - Groups with "account_" prefix (e.g., "account_9876543")
  # Both are stored as custom LDAP attributes in costManagementGroup objectClass
  # See docs/adr/0001-ldap-organization-id-mapping.md for details
  metadata:
    "parse-org-claims":
      opa:
        inlineRego: |
          package authz

          import future.keywords.if
          import future.keywords.in

          # Extract org_id from groups with "organization_id_" prefix
          # Example: "organization_id_1234567" → org_id: "1234567"
          org_id := substring(group, 16, -1) if {
            some group in input.auth.identity.groups
            startswith(group, "organization_id_")
            # Validate the org_id portion is numeric (7-10 digits)
            regex.match(`^organization_id_[0-9]{7,10}$`, group)
          }

          # Default org_id if no organization_id group found
          default org_id := ""

          # Extract account_number from groups with "account_" prefix
          # Example: "account_9876543" → account_number: "9876543"
          # Backend requires BOTH org_id AND account_number for multi-tenant data isolation
          # They must be different identifiers (org_id != account_number)
          account_number := substring(group, 8, -1) if {
            some group in input.auth.identity.groups
            startswith(group, "account_")
            # Validate the account number is numeric (7-10 digits)
            regex.match(`^account_[0-9]{7,10}$`, group)
          }

          # Default: Empty string if no account group found (will trigger auth error)
          # Both org_id and account_number are REQUIRED for backend database queries
          default account_number := ""

  # Response: Inject extracted claims and username as custom headers
  # These will be consumed by Envoy's Lua filter to build rh-identity
  response:
    success:
      headers:
        "X-Auth-Username":
          plain:
            selector: auth.identity.username
        "X-Auth-Uid":
          plain:
            selector: auth.identity.uid
        "X-Auth-Org-Id":
          json:
            selector: auth.metadata.parse-org-claims.org_id
        "X-Auth-Account-Number":
          json:
            selector: auth.metadata.parse-org-claims.account_number
{{- end }}

