{{- if eq (include "cost-onprem.jwt.shouldEnable" .) "true" }}
apiVersion: authorino.kuadrant.io/v1beta3
kind: AuthConfig
metadata:
  name: {{ include "cost-onprem.fullname" . }}-ros-api-auth
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-onprem.labels" . | nindent 4 }}
    app.kubernetes.io/component: authorino-authconfig
spec:
  # Define the hosts that this AuthConfig applies to
  # Use wildcard to match all hosts (Envoy is already doing host validation via routes)
  hosts:
    - "*"

  # Authentication: Validate Kubernetes tokens via TokenReview
  # Accepts tokens with the default Kubernetes API audience
  # This includes:
  #   - Interactive user tokens from OpenShift Console (primary use case)
  #   - Service account tokens without explicit audience
  # The Kubernetes TokenReview API validates the token authenticity
  authentication:
    "kubernetes-tokens":
      kubernetesTokenReview:
        audiences:
          - "https://kubernetes.default.svc"

  # Response: Inject extracted claims and username as custom headers
  # Uses CEL expressions to extract org_id and account_number from LDAP-mapped groups
  # Groups from LDAP via Keycloak follow pattern: cost-mgmt-org-{id}, cost-mgmt-account-{id}
  # See docs/adr/0001-ldap-organization-id-mapping.md for details
  #
  # CEL is preferred over OPA/Rego as Rego is being deprecated in Authorino
  response:
    success:
      headers:
        # Username from TokenReview (path: auth.identity.user.username)
        "X-Auth-Username":
          plain:
            selector: auth.identity.user.username
        # UID from TokenReview (path: auth.identity.user.uid)
        "X-Auth-Uid":
          plain:
            selector: auth.identity.user.uid
        # Extract org_id: filter groups starting with "cost-mgmt-org-", take first, strip prefix
        # Example: ["cost-mgmt-org-1234567", "other-group"] → "1234567"
        # Note: TokenReview returns groups at auth.identity.user.groups
        # "cost-mgmt-org-" is 14 characters (0-indexed)
        "X-Auth-Org-Id":
          plain:
            expression: |
              auth.identity.user.groups.filter(g, g.startsWith("cost-mgmt-org-")).size() > 0
                ? auth.identity.user.groups.filter(g, g.startsWith("cost-mgmt-org-"))[0].substring(14)
                : ""
        # Extract account_number: filter groups starting with "cost-mgmt-account-", take first, strip prefix
        # Example: ["cost-mgmt-account-9876543", "other-group"] → "9876543"
        # "cost-mgmt-account-" is 18 characters (0-indexed)
        "X-Auth-Account-Number":
          plain:
            expression: |
              auth.identity.user.groups.filter(g, g.startsWith("cost-mgmt-account-")).size() > 0
                ? auth.identity.user.groups.filter(g, g.startsWith("cost-mgmt-account-"))[0].substring(18)
                : ""
{{- end }}

