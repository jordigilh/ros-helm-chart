{{- if eq (include "cost-onprem.jwt.shouldEnable" .) "true" }}
apiVersion: authorino.kuadrant.io/v1beta3
kind: AuthConfig
metadata:
  name: {{ include "cost-onprem.fullname" . }}-ros-api-auth
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-onprem.labels" . | nindent 4 }}
    app.kubernetes.io/component: authorino-authconfig
spec:
  # Define the hosts that this AuthConfig applies to
  # Use wildcard to match all hosts (Envoy is already doing host validation via routes)
  hosts:
    - "*"

  # Authentication: Validate Kubernetes tokens via TokenReview
  # Accepts tokens with the default Kubernetes API audience
  # This includes:
  #   - Interactive user tokens from OpenShift Console (primary use case)
  #   - Service account tokens without explicit audience
  # The Kubernetes TokenReview API validates the token authenticity
  # Note: credentials defaults to Authorization header with "Bearer" prefix if omitted
  # Note: Fine-grained authorization (e.g., blocking service accounts) should be
  #       implemented at the application level based on the authenticated username
  authentication:
    "kubernetes-tokens":
      kubernetesTokenReview:
        audiences:
          - "https://kubernetes.default.svc"  # Default Kubernetes API audience

  # Metadata: Extract org_id and account_number from user groups
  # Uses OPA/Rego to parse LDAP-mapped groups from Keycloak
  # Groups structure (Keycloak group hierarchy from LDAP paths):
  #   - Groups under "/organizations/" path (e.g., "/organizations/1234567")
  #   - Groups under "/accounts/" path (e.g., "/accounts/9876543")
  # LDAP stores clean numeric values in separate organizational units
  # See docs/adr/0001-ldap-organization-id-mapping.md for details
  metadata:
    "parse-org-claims":
      opa:
        inlineRego: |
          package authz

          import future.keywords.if
          import future.keywords.in

          # Extract org_id from groups
          # Pattern: "cost-mgmt-org-1234567" (from ldap-user-attrs-to-groups-sync.sh)
          # The prefix prevents collisions with other LDAP groups
          # Use array comprehension to ensure single result even if user has multiple org groups
          org_ids := [trim_prefix(group, "cost-mgmt-org-") |
            some group in input.auth.identity.groups
            startswith(group, "cost-mgmt-org-")
            # Validate the org_id portion is numeric (7-10 digits)
            regex.match(`^cost-mgmt-org-[0-9]{7,10}$`, group)
          ]
          
          # Take first matching org_id (users should have exactly one, but this handles edge cases)
          org_id := org_ids[0] if { count(org_ids) > 0 }
          
          # Default org_id if no cost-mgmt-org- group found
          default org_id := ""

          # Extract account_number from groups
          # Pattern: "cost-mgmt-account-9876543" (from ldap-user-attrs-to-groups-sync.sh)
          # The prefix prevents collisions with other LDAP groups
          # Backend requires BOTH org_id AND account_number for multi-tenant data isolation
          # They must be different identifiers (org_id != account_number)
          # Use array comprehension to ensure single result
          account_numbers := [trim_prefix(group, "cost-mgmt-account-") |
            some group in input.auth.identity.groups
            startswith(group, "cost-mgmt-account-")
            # Validate the account number is numeric (7-10 digits)
            regex.match(`^cost-mgmt-account-[0-9]{7,10}$`, group)
          ]
          
          # Take first matching account_number
          account_number := account_numbers[0] if { count(account_numbers) > 0 }

          # Default: Empty string if no cost-mgmt-account- group found (will trigger auth error)
          # Both org_id and account_number are REQUIRED for backend database queries
          default account_number := ""

  # Response: Inject extracted claims and username as custom headers
  # These will be consumed by Envoy's Lua filter to build rh-identity
  response:
    success:
      headers:
        "X-Auth-Username":
          plain:
            selector: auth.identity.username
        "X-Auth-Uid":
          plain:
            selector: auth.identity.uid
        "X-Auth-Org-Id":
          json:
            selector: auth.metadata.parse-org-claims.org_id
        "X-Auth-Account-Number":
          json:
            selector: auth.metadata.parse-org-claims.account_number
{{- end }}

