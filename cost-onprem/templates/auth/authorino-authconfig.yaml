{{- if eq (include "cost-onprem.jwt.shouldEnable" .) "true" }}
apiVersion: authorino.kuadrant.io/v1beta3
kind: AuthConfig
metadata:
  name: {{ include "cost-onprem.fullname" . }}-ros-api-auth
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-onprem.labels" . | nindent 4 }}
    app.kubernetes.io/component: authorino-authconfig
spec:
  # Define the hosts that this AuthConfig applies to
  # Use wildcard to match all hosts (Envoy is already doing host validation via routes)
  hosts:
    - "*"

  # Authentication: Validate Kubernetes tokens via TokenReview
  # Accepts tokens with the default Kubernetes API audience
  # This includes:
  #   - Interactive user tokens from OpenShift Console (primary use case)
  #   - Service account tokens without explicit audience
  # The Kubernetes TokenReview API validates the token authenticity
  # Note: credentials defaults to Authorization header with "Bearer" prefix if omitted
  # Note: Fine-grained authorization (e.g., blocking service accounts) should be
  #       implemented at the application level based on the authenticated username
  authentication:
    "kubernetes-tokens":
      kubernetesTokenReview:
        audiences:
          - "https://kubernetes.default.svc"  # Default Kubernetes API audience

  # Metadata: Extract org_id and account_number from user groups
  # Uses OPA/Rego to parse LDAP-mapped groups from Keycloak
  # Groups structure:
  #   - Numeric groups (e.g., "1234567") are organization IDs
  #   - Groups with "account_" prefix (e.g., "account_7890123") are account numbers
  # See docs/adr/0001-ldap-organization-id-mapping.md for details
  metadata:
    "parse-org-claims":
      opa:
        inlineRego: |
          package authz

          import future.keywords.if
          import future.keywords.in

          # Extract org_id from groups
          # Looks for first group that matches numeric pattern (7-10 digits)
          org_id := group if {
            some group in input.auth.identity.groups
            # Numeric group names are org IDs (7-10 digits for validation)
            regex.match(`^[0-9]{7,10}$`, group)
          }

          # Default org_id if no numeric group found
          default org_id := ""

          # Extract account_number from groups
          # Looks for groups with pattern "account_<number>"
          account_number := substring(group, 8, -1) if {
            some group in input.auth.identity.groups
            startswith(group, "account_")
            # Validate the account number is numeric
            regex.match(`^account_[0-9]{7,10}$`, group)
          }

          # Fallback: Use org_id as account_number if no specific account group
          # This is common when org_id and account_number are the same
          default account_number := org_id

  # Response: Inject extracted claims and username as custom headers
  # These will be consumed by Envoy's Lua filter to build rh-identity
  response:
    success:
      headers:
        "X-Auth-Username":
          plain:
            selector: auth.identity.username
        "X-Auth-Uid":
          plain:
            selector: auth.identity.uid
        "X-Auth-Org-Id":
          json:
            selector: auth.metadata.parse-org-claims.org_id
        "X-Auth-Account-Number":
          json:
            selector: auth.metadata.parse-org-claims.account_number
{{- end }}

