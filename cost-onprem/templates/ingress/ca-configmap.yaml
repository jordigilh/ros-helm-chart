{{- $keycloakUrl := .Values.jwtAuth.keycloak.url | default (include "cost-onprem.keycloak.url" .) }}
---
# ConfigMap for OpenShift service CA injection
# Note: OpenShift will manage this configmap's data when inject-cabundle is true
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cost-onprem.fullname" . }}-keycloak-ca
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-onprem.labels" . | nindent 4 }}
    app.kubernetes.io/component: ca-trust
  annotations:
    # Auto-inject OpenShift service CA
    service.beta.openshift.io/inject-cabundle: "true"
data: {}
---
# ConfigMap for CA bundle scripts and custom certificates
# Separate from keycloak-ca to avoid OpenShift CA injection overwriting our data
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cost-onprem.fullname" . }}-ca-scripts
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-onprem.labels" . | nindent 4 }}
    app.kubernetes.io/component: ca-trust
data:
  # Custom CA certificate for Keycloak (optional - will auto-fetch if not provided)
  {{- if and .Values.jwtAuth.keycloak .Values.jwtAuth.keycloak.tls .Values.jwtAuth.keycloak.tls.caCert }}
  keycloak-ca.crt: |
{{ .Values.jwtAuth.keycloak.tls.caCert | indent 4 }}
  {{- else }}
  # No custom CA certificate provided - will dynamically fetch from Keycloak endpoint
  # This is the preferred approach as it works automatically in any environment
  keycloak-ca.crt: ""
  {{- end }}

  # Combined CA bundle script (run by init container)
  combine-ca.sh: |
    #!/bin/bash
    set -e

    {{- if .Values.global.debug }}
    echo "üîß Combining CA certificates for Envoy..."
    {{- end }}

    # Start with system CA bundle
    if [ -f /etc/ssl/certs/ca-bundle.crt ]; then
        {{- if .Values.global.debug }}
        echo "üìã Adding system CA bundle..."
        {{- end }}
        cat /etc/ssl/certs/ca-bundle.crt > /tmp/combined-ca.crt
    elif [ -f /etc/ssl/certs/ca-certificates.crt ]; then
        {{- if .Values.global.debug }}
        echo "üìã Adding system CA certificates..."
        {{- end }}
        cat /etc/ssl/certs/ca-certificates.crt > /tmp/combined-ca.crt
    else
        {{- if .Values.global.debug }}
        echo "‚ö†Ô∏è No system CA bundle found, starting with empty bundle"
        {{- end }}
        touch /tmp/combined-ca.crt
    fi

    echo "" >> /tmp/combined-ca.crt

    # Add service account CA (Kubernetes/OpenShift)
    if [ -f /var/run/secrets/kubernetes.io/serviceaccount/ca.crt ]; then
        {{- if .Values.global.debug }}
        echo "üìã Adding Kubernetes service account CA..."
        {{- end }}
        cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt >> /tmp/combined-ca.crt
        echo "" >> /tmp/combined-ca.crt
    fi

    # Add OpenShift service CA (if available)
    if [ -f /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt ]; then
        {{- if .Values.global.debug }}
        echo "üìã Adding OpenShift service CA..."
        {{- end }}
        cat /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt >> /tmp/combined-ca.crt
        echo "" >> /tmp/combined-ca.crt
    fi

    # Add custom Keycloak CA (if provided manually)
    if [ -f /ca-source/keycloak-ca.crt ] && [ -s /ca-source/keycloak-ca.crt ]; then
        # Validate it's a proper certificate
        if openssl x509 -in /ca-source/keycloak-ca.crt -noout -text >/dev/null 2>&1; then
            {{- if .Values.global.debug }}
            echo "üìã Adding manually provided Keycloak CA..."
            {{- end }}
            cat /ca-source/keycloak-ca.crt >> /tmp/combined-ca.crt
            echo "" >> /tmp/combined-ca.crt
            {{- if .Values.global.debug }}
            echo "‚ÑπÔ∏è  Using custom CA certificate from values.yaml"
            {{- end }}
        else
            {{- if .Values.global.debug }}
            echo "‚ö†Ô∏è  Invalid CA certificate in values.yaml, will try to fetch dynamically..."
            {{- end }}
        fi
    else
        {{- if .Values.global.debug }}
        echo "‚ÑπÔ∏è  No custom CA certificate provided in values.yaml (this is fine - will auto-fetch)"
        {{- end }}
    fi

    # Dynamically fetch Keycloak CA certificate from running instance if not already added
    KEYCLOAK_URL="{{ $keycloakUrl | replace "https://" "" | replace "http://" "" }}"
    KEYCLOAK_CERT_COUNT_BEFORE=$(grep -c 'BEGIN CERTIFICATE' /tmp/combined-ca.crt 2>/dev/null || echo 0)
    if [ -n "$KEYCLOAK_URL" ]; then
        {{- if .Values.global.debug }}
        echo "üîç Attempting to fetch Keycloak CA certificate chain from $KEYCLOAK_URL..."
        {{- end }}

        # Extract the ENTIRE certificate chain from Keycloak endpoint (not just the leaf cert)
        # This is more robust as it includes intermediate CAs
        if timeout 10 openssl s_client -connect "$KEYCLOAK_URL:443" -showcerts </dev/null 2>/dev/null > /tmp/keycloak-chain.txt; then

            # Extract all certificates from the chain (not just the first one)
            # Split the chain into individual certificate files
            csplit -z -f /tmp/keycloak-cert- -b '%02d.crt' /tmp/keycloak-chain.txt '/-----BEGIN CERTIFICATE-----/' '{*}' 2>/dev/null || true

            # Add each valid certificate from the chain
            local added_count=0
            for cert_file in /tmp/keycloak-cert-*.crt; do
                if [ -f "$cert_file" ] && grep -q 'BEGIN CERTIFICATE' "$cert_file" 2>/dev/null; then
                    # Verify this is a valid certificate
                    if openssl x509 -in "$cert_file" -noout -text >/dev/null 2>&1; then
                        # Extract just the certificate (removes extra text from s_client output)
                        openssl x509 -in "$cert_file" -outform PEM >> /tmp/keycloak-validated.crt 2>/dev/null || true
                    fi
                fi
            done

            # If we successfully extracted certificates, add them to the bundle
            if [ -f /tmp/keycloak-validated.crt ] && [ -s /tmp/keycloak-validated.crt ]; then
                local new_cert_count=$(grep -c 'BEGIN CERTIFICATE' /tmp/keycloak-validated.crt 2>/dev/null || echo 0)

                if [ "$new_cert_count" -gt 0 ]; then
                    # Check if we already have a custom CA (avoid duplicates)
                    KEYCLOAK_CERT_COUNT_AFTER=$(grep -c 'BEGIN CERTIFICATE' /tmp/combined-ca.crt 2>/dev/null || echo 0)
                    if [ "$KEYCLOAK_CERT_COUNT_AFTER" -eq "$KEYCLOAK_CERT_COUNT_BEFORE" ]; then
                        {{- if .Values.global.debug }}
                        echo "‚úÖ Successfully fetched Keycloak certificate chain ($new_cert_count certificates)"
                        {{- end }}
                        cat /tmp/keycloak-validated.crt >> /tmp/combined-ca.crt
                        echo "" >> /tmp/combined-ca.crt

                        # Display certificate info for verification
                        {{- if .Values.global.debug }}
                        echo "üìú Keycloak Certificate Chain Info:"
                        {{- end }}
                        local cert_num=1
                        for cert_file in /tmp/keycloak-cert-*.crt; do
                            if [ -f "$cert_file" ] && grep -q 'BEGIN CERTIFICATE' "$cert_file" 2>/dev/null; then
                                if openssl x509 -in "$cert_file" -noout -text >/dev/null 2>&1; then
                                    {{- if .Values.global.debug }}
                                    echo "   Certificate $cert_num:"
                                    {{- end }}
                                    openssl x509 -in "$cert_file" -noout -subject -issuer 2>/dev/null | sed 's/^/     /' || true
                                    cert_num=$((cert_num + 1))
                                fi
                            fi
                        done
                    else
                        {{- if .Values.global.debug }}
                        echo "‚ÑπÔ∏è  Keycloak CA already added from custom source, skipping dynamic fetch"
                        {{- end }}
                    fi
                else
                    {{- if .Values.global.debug }}
                    echo "‚ö†Ô∏è  No valid certificates extracted from Keycloak endpoint"
                    {{- end }}
                fi
            else
                {{- if .Values.global.debug }}
                echo "‚ö†Ô∏è  Failed to extract certificates from Keycloak endpoint"
                {{- end }}
            fi

            # Cleanup temporary files
            rm -f /tmp/keycloak-chain.txt /tmp/keycloak-validated.crt /tmp/keycloak-cert-*.crt
        else
            {{- if .Values.global.debug }}
            echo "‚ö†Ô∏è  Could not connect to $KEYCLOAK_URL (may be using system CA or endpoint unreachable)"
            {{- end }}
            {{- if .Values.global.debug }}
            echo "   This is normal if Keycloak uses a certificate signed by a system-trusted CA"
            {{- end }}
        fi
    fi

    # Add injected OpenShift CA bundle (if available)
    if [ -f /ca-source/service-ca.crt ]; then
        {{- if .Values.global.debug }}
        echo "üìã Adding OpenShift injected CA bundle..."
        {{- end }}
        cat /ca-source/service-ca.crt >> /tmp/combined-ca.crt
        echo "" >> /tmp/combined-ca.crt
    fi

    # Copy to shared volume
    cp /tmp/combined-ca.crt /ca-output/ca-bundle.crt

    {{- if .Values.global.debug }}
    echo "‚úÖ Combined CA bundle created with $(grep -c 'BEGIN CERTIFICATE' /ca-output/ca-bundle.crt) certificates"
    {{- end }}
    {{- if .Values.global.debug }}
    echo "üìÑ CA bundle size: $(wc -c < /ca-output/ca-bundle.crt) bytes"
    {{- end }}

    # List CA sources for debugging
    {{- if .Values.global.debug }}
    echo "üîç CA sources included:"
    {{- end }}
    if grep -q "Kubernetes Service Account CA" /ca-output/ca-bundle.crt; then
        {{- if .Values.global.debug }}
        echo "   ‚úÖ Kubernetes Service Account CA"
        {{- end }}
    fi
    if grep -q "OpenShift Service CA" /ca-output/ca-bundle.crt; then
        {{- if .Values.global.debug }}
        echo "   ‚úÖ OpenShift Service CA"
        {{- end }}
    fi
    if grep -q "Keycloak Custom CA" /ca-output/ca-bundle.crt; then
        {{- if .Values.global.debug }}
        echo "   ‚úÖ Keycloak Custom CA (manually provided)"
        {{- end }}
    fi
    if grep -q "Keycloak Dynamically Fetched CA" /ca-output/ca-bundle.crt; then
        {{- if .Values.global.debug }}
        echo "   ‚úÖ Keycloak CA (dynamically fetched)"
        {{- end }}
    fi
    if grep -q "OpenShift Injected CA Bundle" /ca-output/ca-bundle.crt; then
        {{- if .Values.global.debug }}
        echo "   ‚úÖ OpenShift Injected CA Bundle"
        {{- end }}
    fi
