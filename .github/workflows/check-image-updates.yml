name: Check Component Updates

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    name: Check Component Updates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for component updates
        id: check
        env:
          REDHAT_REGISTRY_TOKEN: ${{ secrets.REDHAT_REGISTRY_TOKEN }}
        run: |
          chmod +x scripts/check-image-updates.sh
          
          # Parse values.yaml directly for current image references
          declare -A images
          
          # Extract image repo/tag pairs from values.yaml
          while IFS= read -r line; do
            if [[ "$line" =~ repository:\ *(.+) ]]; then
              repo="${BASH_REMATCH[1]//\"/}"
              repo="${repo//\'/}"
            elif [[ "$line" =~ tag:\ *(.+) ]]; then
              tag="${BASH_REMATCH[1]//\"/}"
              tag="${tag//\'/}"
              if [[ -n "${repo:-}" ]]; then
                images["$repo"]="$tag"
                repo=""
              fi
            fi
          done < cost-onprem/values.yaml
          
          updates=""
          declare -A updates_map
          
          for image in "${!images[@]}"; do
            tag="${images[$image]}"
            
            # Skip digest-based or "latest" tags
            [[ "$tag" == sha256:* || "$tag" == "latest" ]] && continue
            
            # Check quay.io images
            if [[ "$image" == quay.io/* ]]; then
              repo_path="${image#quay.io/}"
              api_url="https://quay.io/api/v1/repository/${repo_path}/tag/?limit=10&onlyActiveTags=true"
              
              response=$(curl -sf "$api_url" 2>/dev/null) || continue
              latest=$(echo "$response" | jq -r '[.tags[] | select(.name != "latest")] | sort_by(.start_ts) | reverse | .[0].name // empty')
              
              if [[ -n "$latest" && "$latest" != "$tag" ]]; then
                updates="${updates}${image}: ${tag} -> ${latest}\n"
                updates_map["$tag"]="$latest"
              fi
            fi
          done
          
          if [[ -n "$updates" ]]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo -e "Updates found:\n$updates"
            {
              echo "updates<<EOF"
              echo -e "$updates"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            
            # Store updates as JSON for the update step
            json="{"
            first=true
            for old_tag in "${!updates_map[@]}"; do
              if [[ "$first" == "true" ]]; then
                first=false
              else
                json+=","
              fi
              json+="\"$old_tag\":\"${updates_map[$old_tag]}\""
            done
            json+="}"
            echo "updates_json=$json" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "All tracked components are up to date"
          fi

      - name: Update values.yaml
        if: steps.check.outputs.has_updates == 'true'
        id: update
        run: |
          updates_json='${{ steps.check.outputs.updates_json }}'
          
          for old_tag in $(echo "$updates_json" | jq -r 'keys[]'); do
            new_tag=$(echo "$updates_json" | jq -r --arg k "$old_tag" '.[$k]')
            echo "Updating tag: $old_tag -> $new_tag"
            sed -i "s|tag: \"$old_tag\"|tag: \"$new_tag\"|g" cost-onprem/values.yaml
            sed -i "s|tag: '$old_tag'|tag: '$new_tag'|g" cost-onprem/values.yaml
          done
          
          if git diff --quiet cost-onprem/values.yaml; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true' && steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update component versions"
          branch: automated/component-updates
          delete-branch: true
          title: "chore: update component versions"
          body: |
            ## Automated Component Updates

            The following components have been updated:

            ```
            ${{ steps.check.outputs.updates }}
            ```

            ---
            *Automatically generated by check-component-updates workflow*
          labels: |
            component-update
            automated

