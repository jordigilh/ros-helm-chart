# Check Components Workflow
#
# Monitors container images tagged as "latest" in values.yaml for updates.
# Only tracks latest-tagged images - pinned versions are intentionally ignored.
#
# Modes:
#   - check-updates (default): Compare digests against cache, create issue if changed
#   - list-versions: Report current digests and last modified dates
#
# Schedule: Every 30 minutes
# Manual: Run via workflow_dispatch with mode selection

name: Check Components

on:
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode: check-updates or list-versions'
        required: false
        default: 'check-updates'
        type: choice
        options:
          - check-updates
          - list-versions

permissions:
  contents: read
  issues: write

jobs:
  check-components:
    name: Check Components
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore digest cache
        if: inputs.mode != 'list-versions'
        uses: actions/cache@v4
        with:
          path: .digest-cache
          key: component-digests-${{ github.run_id }}
          restore-keys: component-digests-

      - name: Check components
        id: check
        env:
          MODE: ${{ inputs.mode || 'check-updates' }}
        run: ./scripts/qe/check-components.sh

      - name: Report versions
        if: steps.check.outputs.mode == 'list-versions'
        run: |
          echo "## Component Versions"
          echo ""
          echo "${{ steps.check.outputs.versions }}"

      - name: Create or update issue
        if: steps.check.outputs.mode == 'check-updates' && steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Component Updates Detected';
            const labels = ['component-update', 'automated'];
            const updates = `${{ steps.check.outputs.updates }}`;
            const date = new Date().toISOString().split('T')[0];
            
            const body = `## Component Updates Detected

            The following container images have new versions available:

            \`\`\`
            ${updates}
            \`\`\`

            ### Action Required

            Review the changes and decide if an update is needed:

            1. **Review** the upstream changes for each component
            2. **Test** the new versions in a development environment
            3. **Update** \`values.yaml\` if the changes are acceptable
            4. **Close** this issue once addressed

            ---
            *Last checked: ${date}*
            *Automatically generated by check-components workflow*`;

            // Check for existing open issue with same title
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: labels.join(',')
            });

            const existingIssue = existingIssues.data.find(issue => issue.title === title);

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });
              console.log(`Created new issue #${newIssue.data.number}`);
            }
