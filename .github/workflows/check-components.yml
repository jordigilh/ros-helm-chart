# Check Components Workflow
#
# Monitors container images tagged as "latest" in values.yaml for updates.
# Only tracks latest-tagged images - pinned versions are intentionally ignored.
#
# Modes:
#   - check-updates (default): Compare digests against cache, create PR if changed
#   - list-versions: Report current digests and last modified dates
#
# Schedule: Every 30 minutes
# Manual: Run via workflow_dispatch with mode selection

name: Check Components

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode: check-updates or list-versions'
        required: false
        default: 'check-updates'
        type: choice
        options:
          - check-updates
          - list-versions

permissions:
  contents: write
  pull-requests: write

jobs:
  check-components:
    name: Check Components
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore digest cache
        if: inputs.mode != 'list-versions'
        uses: actions/cache@v4
        with:
          path: .digest-cache
          key: component-digests-${{ github.run_id }}
          restore-keys: component-digests-

      - name: Check components
        id: check
        env:
          MODE: ${{ inputs.mode || 'check-updates' }}
        run: ./scripts/qe/check-components.sh

      - name: Report versions
        if: steps.check.outputs.mode == 'list-versions'
        run: |
          echo "## Component Versions"
          echo ""
          echo "${{ steps.check.outputs.versions }}"

      - name: Get current date
        id: date
        if: steps.check.outputs.mode == 'check-updates' && steps.check.outputs.has_updates == 'true'
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Close existing PR
        if: steps.check.outputs.mode == 'check-updates' && steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:automated/component-updates`
            });
            
            for (const pr of prs.data) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                state: 'closed'
              });
              console.log(`Closed existing, redundant PR #${pr.number} as it is now superseded by the new PR`);
            }

      - name: Create Pull Request
        if: steps.check.outputs.mode == 'check-updates' && steps.check.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: component updates detected"
          branch: automated/component-updates
          delete-branch: true
          title: "chore: component updates detected - ${{ steps.date.outputs.date }}"
          body: |
            ## Component Updates Detected

            The following components have been updated:

            ```
            ${{ steps.check.outputs.updates }}
            ```

            **Action Required:** Review the changes and test the updated components.

            ---
            *Automatically generated by check-components workflow*
          labels: |
            component-update
            automated
