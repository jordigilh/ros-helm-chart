name: Check Component Updates

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

permissions:
  issues: write

jobs:
  check-updates:
    name: Check Component Updates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore digest cache
        uses: actions/cache@v4
        with:
          path: .digest-cache
          key: component-digests-${{ github.run_id }}
          restore-keys: component-digests-

      - name: Check for component updates
        id: check
        run: |
          mkdir -p .digest-cache
          declare -A images
          
          # Extract image repo/tag pairs from values.yaml
          while IFS= read -r line; do
            if [[ "$line" =~ repository:\ *(.+) ]]; then
              repo="${BASH_REMATCH[1]//\"/}"
              repo="${repo//\'/}"
            elif [[ "$line" =~ tag:\ *(.+) ]]; then
              tag="${BASH_REMATCH[1]//\"/}"
              tag="${tag//\'/}"
              if [[ -n "${repo:-}" ]]; then
                images["$repo"]="$tag"
                repo=""
              fi
            fi
          done < cost-onprem/values.yaml
          
          updates=""
          
          for image in "${!images[@]}"; do
            tag="${images[$image]}"
            
            # Only check images tagged as "latest"
            [[ "$tag" != "latest" ]] && continue
            
            # Check quay.io images
            if [[ "$image" == quay.io/* ]]; then
              repo_path="${image#quay.io/}"
              cache_file=".digest-cache/${repo_path//\//_}.digest"
              api_url="https://quay.io/api/v1/repository/${repo_path}/tag/?limit=1&specificTag=latest"
              
              response=$(curl -sf "$api_url" 2>/dev/null) || continue
              current_digest=$(echo "$response" | jq -r '.tags[0].manifest_digest // empty')
              
              [[ -z "$current_digest" ]] && continue
              
              # Compare with cached digest
              if [[ -f "$cache_file" ]]; then
                previous_digest=$(cat "$cache_file")
                if [[ "$current_digest" != "$previous_digest" ]]; then
                  updates="${updates}${image}:latest (digest changed)\n"
                fi
              fi
              
              # Update cache
              echo "$current_digest" > "$cache_file"
            fi
          done
          
          if [[ -n "$updates" ]]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            {
              echo "updates<<EOF"
              echo -e "$updates"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "All components are up to date"
          fi

      - name: Create or update issue
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const updates = `${{ steps.check.outputs.updates }}`;
            const title = 'Component Updates Available';
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'component-update'
            });
            
            const existingIssue = issues.data.find(i => i.title === title);
            
            const body = [
              '## Component Updates Detected',
              '',
              'The following components have been updated:',
              '',
              '```',
              updates,
              '```',
              '',
              '**Action Required:** Review the changes and test the updated components.',
              '',
              '---',
              '*Automatically generated by check-component-updates workflow*'
            ].join('\n');
            
            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['component-update']
              });
            }
