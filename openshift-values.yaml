# Testing/CI Values Overlay for Cost Management On-Premise
# =========================================================
# This file provides OVERRIDES for testing and CI environments only.
# It is layered on top of the base values.yaml during helm install.
#
# Purpose:
# - Smaller resource allocations suitable for testing environments
# - Reduced storage sizes (5Gi vs production sizes)
# - CI optimization hints to reduce Helm API lookups
#
# For production deployments, use larger values:
#   --set database.ros.storage.size=100Gi
#   --set resources.kruize.requests.memory=2Gi

global:
  # Cluster domain - auto-detected if empty, but providing it skips 4 API lookups
  # CI script will set this dynamically: $(oc get ingresses.config.openshift.io cluster -o jsonpath='{.spec.domain}')
  clusterDomain: ""  # Set by CI or leave empty for auto-detection

  # Cluster name - auto-detected if empty, but providing it skips 2 API lookups
  clusterName: ""  # Set by CI or leave empty for auto-detection

  # Storage type for platform detection (overrides empty default in values.yaml)
  storageType: "odf"

# Explicit storage class names to avoid API lookups (optional but recommended for CI)
# When provided, skips StorageClass list/get API calls (saves 2-4 lookups)
# storageClassNames:
#   database: "odf-storagecluster-ceph-rbd"
#   kafka: "odf-storagecluster-ceph-rbd"
#   storage: "odf-storagecluster-ceph-rbd"
#   valkey: "odf-storagecluster-ceph-rbd"

# Reduced resource requirements for testing environment
# Production recommendation: Increase memory for Kruize (2-4Gi)
resources:
  application:
    requests:
      memory: "512Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "500m"

  kruize:
    requests:
      memory: "1Gi"
      cpu: "200m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

# Use smaller storage sizes for testing
# Production recommendation: 100Gi for ros/kruize, 50Gi for sources
database:
  ros:
    storage:
      size: "5Gi"

  kruize:
    storage:
      size: "5Gi"

  sources:
    storage:
      size: "5Gi"

# ODF (Production Storage - for OpenShift deployments)
# Replaces MinIO on OpenShift
#
# RECOMMENDED APPROACH: Direct Ceph RGW (Required for Cost Management)
# -----------------------------------------------------------------------
# Cost Management requires strong read-after-write consistency for S3.
# NooBaa's eventual consistency causes 403 errors when reading immediately after write.
# Direct Ceph RGW provides strong consistency and is the REQUIRED storage backend.
#
# To use Direct Ceph RGW (RECOMMENDED):
# 1. Create an ObjectBucketClaim BEFORE running the install script:
#
#    kubectl apply -f - <<EOF
#    apiVersion: objectbucket.io/v1alpha1
#    kind: ObjectBucketClaim
#    metadata:
#      name: ros-data-ceph
#      namespace: cost-onprem
#    spec:
#      generateBucketName: ros-data-ceph
#      storageClassName: ocs-storagecluster-ceph-rgw
#    EOF
#
# 2. The install script will auto-detect the OBC and:
#    - Extract bucket name, endpoint, and credentials
#    - Configure all components to use Direct Ceph RGW
#    - Skip the bucket creation job (bucket managed by OBC)
#
# FALLBACK: NooBaa (NOT RECOMMENDED for Cost Management)
# -------------------------------------------------------
# If no external OBC is detected, the chart falls back to NooBaa auto-detection.
# WARNING: NooBaa's eventual consistency may cause data processing failures.
#
odf:
  endpoint: ""  # Auto-detected: Ceph RGW (if OBC exists) or NooBaa (fallback)
  port: 443
  useSSL: true
  bucket: "ros-data"  # Only used for NooBaa fallback

  # External ObjectBucketClaim (OBC) configuration
  # Set to true when using pre-created OBC for Direct Ceph RGW
  # The install script auto-detects OBC named "ros-data-ceph" and sets this automatically
  useExternalOBC: false  # Auto-set to true by install script when OBC is detected

# JWT Authentication configuration (avoids Keycloak auto-discovery lookups)
# Providing explicit Keycloak settings saves ~8 API lookups
# CI script will set this dynamically: $(oc get route -n keycloak keycloak -o jsonpath='{.spec.host}')
jwtAuth:
  keycloak:
    # url: ""  # Set by CI script, e.g., "https://keycloak.apps.example.com"
    installed: true  # Tells chart Keycloak exists, skips CR lookup
    # namespace: "keycloak"  # Optional: skip namespace discovery
    # serviceName: "keycloak"  # Optional: skip service discovery

# Authentication configuration
# OpenShift uses native OAuth/RBAC, so we disable custom JWT auth
ingress:
  auth:
    enabled: false  # Use OpenShift native authentication
  upload:
    requireAuth: false  # Authentication handled by OpenShift Routes

# OpenShift Routes configuration
# Override: longer timeout (300s vs 30s default) for large file uploads
serviceRoute:
  enabled: true
  annotations:
    haproxy.router.openshift.io/timeout: "300s"
  tls:
    # TLS disabled by default for testing; enable for production:
    # termination: edge
    # insecureEdgeTerminationPolicy: Redirect