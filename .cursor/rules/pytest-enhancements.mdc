---
description: Pytest suite enhancements - parity with e2e_validator and bash scripts
globs: ["tests/**"]
alwaysApply: false
---

# Pytest Enhancements

## Overview

This document tracked the implementation of pytest enhancements to achieve parity with:
- `scripts/test-ocp-dataflow-jwt.sh` (bash E2E test)
- `scripts/cost-mgmt-ocp-dataflow.sh` (OCP dataflow validation)
- `scripts/e2e_validator/` (Python E2E framework)

**Status: All P1, P2, and P3 items are complete.**

---

## Implementation Summary

### Test Files Created

| File | Tests | Description |
|------|-------|-------------|
| `tests/suites/infrastructure/test_kafka.py` | 10 | Kafka cluster, topics, listener validation |
| `tests/suites/infrastructure/test_storage.py` | 6 | S3 endpoint, buckets, connectivity |
| `tests/suites/cost_management/test_cost_validation.py` | 14 | Cost metrics vs NISE expected values |
| `tests/suites/cost_management/test_processing_state.py` | 12 | Manifest/file processing state |
| `tests/suites/e2e/test_scenarios.py` | 35 | YAML-driven scenario definitions |

**Total New Tests: 77**
**Total Test Suite: ~163 tests**

### Markers Added

```ini
# pytest.ini
markers =
    infrastructure: Infrastructure health tests (DB, S3, Kafka, storage)
    cost_validation: Cost calculation validation tests (metrics, tolerances)
    scenario: YAML-driven scenario tests for different workload patterns
```

### Environment Variables Added

| Variable | Default | Description |
|----------|---------|-------------|
| `KAFKA_NAMESPACE` | `kafka` | Kafka cluster namespace |
| `E2E_COST_TOLERANCE` | `0.05` | Tolerance for cost validation (5%) |

---

## Implementation Status

| Item | Status | Files |
|------|--------|-------|
| P1.1 Kafka validation | ✅ Complete | `tests/suites/infrastructure/test_kafka.py` |
| P1.2 S3/Storage preflight | ✅ Complete | `tests/suites/infrastructure/test_storage.py` |
| P2.1 Database preflight | ✅ Already existed | `tests/suites/infrastructure/test_database.py` |
| P2.2 Cost validation | ✅ Complete | `tests/suites/cost_management/test_cost_validation.py` |
| P2.3 Multi-provider (OCP) | ✅ Framework exists | OCP implemented; AWS/Azure/GCP deferred |
| P3.1 YAML scenarios | ✅ Complete | `tests/suites/e2e/test_scenarios.py` |
| P3.2 Processing state | ✅ Complete | `tests/suites/cost_management/test_processing_state.py` |

---

## Testing Commands

```bash
# Run all infrastructure tests (Kafka, S3, DB)
./scripts/run-pytest.sh -- -m infrastructure

# Run cost validation tests
./scripts/run-pytest.sh -- -m cost_validation

# Run scenario tests
./scripts/run-pytest.sh -- -m scenario

# Run with custom cost tolerance (10%)
E2E_COST_TOLERANCE=0.10 ./scripts/run-pytest.sh -- -m cost_validation

# Run specific test files
pytest tests/suites/infrastructure/test_kafka.py -v
pytest tests/suites/infrastructure/test_storage.py -v
pytest tests/suites/cost_management/test_cost_validation.py -v -m extended
pytest tests/suites/cost_management/test_processing_state.py -v
pytest tests/suites/e2e/test_scenarios.py -v -m scenario
```

---

## Suite READMEs

Each suite has detailed documentation:

- `tests/suites/infrastructure/README.md` - Kafka and S3 tests
- `tests/suites/cost_management/README.md` - Cost validation and processing state
- `tests/suites/e2e/README.md` - YAML-driven scenarios

---

## Key Implementation Details

### Kafka Tests (`test_kafka.py`)
- Uses `strimzi.io/broker-role=true` label to find actual Kafka brokers
- Validates topics: `platform.upload.announce`, `hccm.ros.events`
- Checks listener pod connectivity via log parsing

### S3 Tests (`test_storage.py`)
- Uses Python/boto3 inside pods (AWS CLI not available in Koku containers)
- Configures `addressing_style: "path"` for on-prem S3 compatibility
- Discovers S3 endpoint from route, pod env, or default ODF endpoint

### Cost Validation (`test_cost_validation.py`)
- Compares actual DB values against NISE expected values
- Configurable tolerance via `E2E_COST_TOLERANCE` env var
- Validates CPU hours, memory GB-hours, node/namespace/pod counts

### Processing State (`test_processing_state.py`)
- Monitors manifest state transitions
- Detects stuck manifests and failed files
- Validates file processing completion rate (>50%)

### YAML Scenarios (`test_scenarios.py`)
- 4 built-in scenarios: minimal, multi-pod, multi-namespace, high-utilization
- Dynamic date injection to avoid Koku "missing dates" errors
- Expected values calculated based on scenario definition

---

## Future Enhancements

- Multi-provider support (AWS, Azure, GCP) - currently OCP only
- Additional NISE scenarios (cost allocation tags, multi-node clusters)
- Performance benchmarking tests
