{{- if eq (include "cost-mgmt.jwt.shouldEnable" .) "true" }}
{{/*
Debug ConfigMap to show Keycloak auto-detection results
This will be created when JWT auth is enabled to help troubleshoot Keycloak detection
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cost-mgmt.fullname" . }}-keycloak-debug
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-mgmt.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-1"
data:
  keycloak-detection-results.yaml: |
    # Keycloak Auto-Detection Results (Using Keycloak CRs)
    # ====================================================

    # Detection Results:
    keycloak_installed: {{ include "cost-mgmt.keycloak.isInstalled" . | quote }}
    keycloak_namespace: {{ include "cost-mgmt.keycloak.namespace" . | quote }}
    keycloak_service_name: {{ include "cost-mgmt.keycloak.serviceName" . | quote }}
    keycloak_auto_url: {{ include "cost-mgmt.keycloak.url" . | quote }}

    # Keycloak CR Information:
{{ include "cost-mgmt.keycloak.crInfo" . | indent 4 }}

    # Computed URLs:
    issuer_url: {{ include "cost-mgmt.keycloak.issuerUrl" . | quote }}
    jwks_url: {{ include "cost-mgmt.keycloak.jwksUrl" . | quote }}

    # Configuration Used:
    jwt_auth_enabled: {{ include "cost-mgmt.jwt.shouldEnable" . | quote }}
    manual_base_url: {{ .Values.jwtAuth.keycloak.url | quote }}
    realm: {{ .Values.jwtAuth.keycloak.realm | quote }}

    # Platform Detection:
    is_openshift: {{ include "cost-mgmt.platform.isOpenShift" . | quote }}

    # JWT Authentication Method:
    auth_method: "Envoy Native JWT Filter"
    auth_description: "Inline JWT validation without external authorization service"

    # How to use this information:
    # ============================
    # 1. Check if keycloak_installed is 'true'
    # 2. Look at 'found' in CR info to see if Keycloak CRs were detected
    # 3. Check 'ready' status to ensure Keycloak is operational
    # 4. Verify keycloak_auto_url or externalURL points to your Keycloak instance
    # 5. If issuer_url looks correct, JWT auth should work
    # 6. If auto-detection fails, set jwt_auth.keycloak.url manually

    # Troubleshooting:
    # ================
    # - If keycloak_installed is 'false': No Keycloak CRs found, may not be installed via operator
    # - If 'found' is false but keycloak_installed is true: Using fallback namespace detection
    # - If 'ready' is false: Keycloak CR exists but instance may not be ready
    # - If keycloak_auto_url is empty: No route/ingress found, check Keycloak external access
    # - If issuer_url is wrong: Override with manual jwt_auth.keycloak.url

    # Detection Method Priority:
    # =========================
    # 1. Keycloak CRs (keycloaks.keycloak.org) - Most reliable
    # 2. CR status.externalURL - Direct from operator
    # 3. OpenShift Routes - Platform integration
    # 4. Kubernetes Ingresses - Platform integration
    # 5. Service discovery - Fallback method
{{- end }}
