{{- if eq (include "cost-management-onprem.isOpenShift" $) "true" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cost-mgmt.fullname" . }}-ca-combine
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-mgmt.labels" . | nindent 4 }}
    app.kubernetes.io/component: ca-trust
data:
  combine-ca.sh: |
    #!/bin/bash
    set -e

    echo "ðŸ”§ Combining CA certificates for Python SSL..."

    # Start with system CA bundle
    if [ -f /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem ]; then
        echo "ðŸ“‹ Adding system CA bundle..."
        cat /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem > /tmp/combined-ca.crt
    elif [ -f /etc/ssl/certs/ca-bundle.crt ]; then
        echo "ðŸ“‹ Adding system CA bundle..."
        cat /etc/ssl/certs/ca-bundle.crt > /tmp/combined-ca.crt
    elif [ -f /etc/ssl/certs/ca-certificates.crt ]; then
        echo "ðŸ“‹ Adding system CA certificates..."
        cat /etc/ssl/certs/ca-certificates.crt > /tmp/combined-ca.crt
    else
        echo "âš ï¸ No system CA bundle found, starting with empty bundle"
        touch /tmp/combined-ca.crt
    fi

    echo "" >> /tmp/combined-ca.crt

    # Add OpenShift cluster root CA (Kubernetes service account CA)
    if [ -f /var/run/secrets/kubernetes.io/serviceaccount/ca.crt ]; then
        echo "ðŸ“‹ Adding OpenShift cluster root CA..."
        cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt >> /tmp/combined-ca.crt
        echo "" >> /tmp/combined-ca.crt
    fi

    # Add OpenShift Service CA (signs *.svc certificates like s3.openshift-storage.svc)
    if [ -f /ca-source/service-ca.crt ] && [ -s /ca-source/service-ca.crt ]; then
        echo "ðŸ“‹ Adding OpenShift Service CA..."
        cat /ca-source/service-ca.crt >> /tmp/combined-ca.crt
        echo "" >> /tmp/combined-ca.crt
    fi

    # Copy to shared volume
    cp /tmp/combined-ca.crt /ca-output/ca-bundle.crt

    echo "âœ… Combined CA bundle created with $(grep -c 'BEGIN CERTIFICATE' /ca-output/ca-bundle.crt) certificates"
    echo "ðŸ“„ CA bundle size: $(wc -c < /ca-output/ca-bundle.crt) bytes"
{{- end }}

